name: Release Linux Bundle

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          set -euxo pipefail
          pacman -Syu --noconfirm --needed \
            base-devel rust cargo pkgconf clang perl git \
            gtk4 libadwaita

      - name: Build binaries
        run: |
          set -euxo pipefail
          cargo build --release --locked --bins

      - name: Create release bundle
        run: |
          set -euxo pipefail

          bundle_root="dist/aurora-linux-x86_64"
          rm -rf "$bundle_root"

          install -Dm755 target/release/aurora "$bundle_root/aurora"
          install -Dm755 target/release/aurora-helper "$bundle_root/aurora-helper"

          install -Dm644 resources/io.github.ahmoodio.aurora.desktop \
            "$bundle_root/resources/io.github.ahmoodio.aurora.desktop"
          install -Dm644 resources/io.github.ahmoodio.aurora.metainfo.xml \
            "$bundle_root/resources/io.github.ahmoodio.aurora.metainfo.xml"
          install -Dm644 resources/io.github.ahmoodio.aurora.policy \
            "$bundle_root/resources/io.github.ahmoodio.aurora.policy"

          install -Dm644 assets/icons/hicolor/256x256/apps/io.github.ahmoodio.aurora.png \
            "$bundle_root/assets/icons/hicolor/256x256/apps/io.github.ahmoodio.aurora.png"
          install -Dm644 assets/icons/hicolor/scalable/apps/io.github.ahmoodio.aurora.png \
            "$bundle_root/assets/icons/hicolor/scalable/apps/io.github.ahmoodio.aurora.png"

          tar -C dist -czf dist/aurora-linux-x86_64.tar.gz aurora-linux-x86_64
          sha256sum dist/aurora-linux-x86_64.tar.gz > dist/aurora-linux-x86_64.tar.gz.sha256

      - name: Upload bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: aurora-linux-x86_64
          path: |
            dist/aurora-linux-x86_64.tar.gz
            dist/aurora-linux-x86_64.tar.gz.sha256

      - name: Publish release assets
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/aurora-linux-x86_64.tar.gz
            dist/aurora-linux-x86_64.tar.gz.sha256
          generate_release_notes: true
